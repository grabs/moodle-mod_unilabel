define("unilabeltype_imageboard/imageboardpreviewrenderer",["exports","core/templates","core/str","core/log","core/config"],(function(_exports,_templates,Str,_log,_config){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Str),_log=_interopRequireDefault(_log),_config=_interopRequireDefault(_config);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}_exports.init=async(canvaswidth,canvasheight,gridcolor,xsteps,ysteps)=>{canvaswidth=parseInt(canvaswidth,10),canvasheight=parseInt(canvasheight,10),xsteps=parseInt(xsteps,10),ysteps=parseInt(ysteps,10);let emptyPictureSrc=_config.default.wwwroot+"/mod/unilabel/type/imageboard/pix/empty-picture.gif",imageList=new Array,lastImageNumber=-1;await async function(){var mform=document.querySelectorAll('[id^="mform"]')[0];mform.addEventListener("change",(async event=>{await onChangeAttribute(event)})),mform.addEventListener("keyup",(async event=>{await onChangeAttribute(event)})),mform.addEventListener("itemadded",(event=>{addImageToDom(parseInt(lastImageNumber)+1)})),mform.addEventListener("itemremoved",(event=>{!function(event){let removedImage=document.querySelector("#unilabel-imageboard-element-"+event.detail);removedImage&&removedImage.remove()}(event)})),mform.addEventListener("click",onclickExecute,!1),mform.addEventListener("contextmenu",onRightclick,!1);let backgroundfileNode=document.getElementById("id_unilabeltype_imageboard_backgroundimage_fieldset");if(require(["core_form/events"],(function(FormEvent){backgroundfileNode.addEventListener(FormEvent.eventTypes.uploadChanged,(event=>{const filemanager=event.target,interval=setInterval((async()=>{if(!filemanager.classList.contains("fm-updating")&&(clearInterval(interval),filemanager.classList.contains("fm-noitems"))){event.target.getElementsByTagName("img")[0].remove(),refreshBackgroundImage()}}),100)}))})),backgroundfileNode){new MutationObserver(refreshBackgroundImage).observe(backgroundfileNode,{attributes:!0,childList:!0,subtree:!0})}let canvasx=document.getElementById("id_unilabeltype_imageboard_canvaswidth");canvasx&&canvasx.addEventListener("change",refreshBackgroundImage);let canvasy=document.getElementById("id_unilabeltype_imageboard_canvasheight");canvasy&&canvasy.addEventListener("change",refreshBackgroundImage)}(),await refreshBackgroundImage(),await async function(){const singleElements=document.querySelectorAll('[id^="fitem_id_unilabeltype_imageboard_image_"]');for(let i=0;i<singleElements.length;i++){let number=singleElements[i].getAttribute("id").split("fitem_id_unilabeltype_imageboard_image_")[1];document.getElementById("unilabel-imageboard-element-"+number)||await addImageToDom(number),refreshImage(number)}}(),await async function(canvaswidth,canvasheight,gridcolor,xsteps,ysteps){let gridcontent=await getHelpergrid(canvaswidth,canvasheight,gridcolor,xsteps,ysteps),combined="<div>"+document.getElementById("imageboardcontainer").innerHTML+"</div>"+gridcontent.resultHtml;return void _templates.default.replaceNodeContents("#imageboardcontainer",combined,gridcontent.resultJs)}(canvaswidth,canvasheight,gridcolor,xsteps,ysteps);const gridtoggler=document.getElementById("unilabeltype-imageboard-gridtoggler-0"),togglerText=gridtoggler.querySelector(".unilabeltype-imageboard-toggle-text");gridtoggler.addEventListener("click",(function(event){const helpergrid=document.getElementById("unilabeltype-imageboard-helpergrid-0");event.stopPropagation(),event.preventDefault(),helpergrid.classList.contains("hidden")?function(button,helpergrid){helpergrid.classList.remove("hidden"),button.value="gridvisible",Str.get_string("buttonlabelhelpergridhide","unilabeltype_imageboard").done((function(text){button.innerText=text}))}(togglerText,helpergrid):function(button,helpergrid){helpergrid.classList.add("hidden"),button.value="gridhidden",Str.get_string("buttonlabelhelpergridshow","unilabeltype_imageboard").done((function(text){button.innerText=text}))}(togglerText,helpergrid)}));async function onChangeAttribute(event){let technicalnumber=-1;const eventid=event.target.getAttribute("id");let eventsourceimagesetting=eventid.split("id-unilabeltype-imageboard-imagesettings-dialog-")[1],eventsourceform=eventid.split("id_unilabeltype_imageboard_")[1];void 0===eventsourceimagesetting&&void 0===eventsourceform||(void 0!==eventsourceimagesetting&&""!==eventsourceimagesetting&&(technicalnumber=function(eventsourceimagesetting){const technicalnumber=parseInt(document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-number").innerHTML)-1;let value=document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-"+eventsourceimagesetting).value;if("xposition"===eventsourceimagesetting||"yposition"===eventsourceimagesetting||"border"===eventsourceimagesetting||"borderradius"===eventsourceimagesetting){let num=Number(value);if(""!==value&&!Number.isInteger(num))return-1}let field=document.getElementById("id_unilabeltype_imageboard_"+eventsourceimagesetting+"_"+technicalnumber);null!==field&&(field.value=value);return technicalnumber}(eventsourceimagesetting)),void 0!==eventsourceform&&""!==eventsourceform&&(technicalnumber=eventsourceform.substr(eventsourceform.length-1,eventsourceform.length),writeFormdataOfImageToImagesettingsdialogupdate(technicalnumber)),technicalnumber>=0&&refreshImage(technicalnumber))}function onRightclick(event){event.preventDefault();var idoftarget=event.target.getAttribute("id");if(!idoftarget)return;let technicalnumber=idoftarget.split("unilabel-imageboard-imageid-")[1];if(technicalnumber||(technicalnumber=idoftarget.split("id_elementtitle-")[1]),technicalnumber){writeFormdataOfImageToImagesettingsdialogupdate(technicalnumber);technicalnumber==parseInt(document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-number").innerHTML)?function(){let imagesettingsdiv=document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog");imagesettingsdiv&&imagesettingsdiv.style&&"visible"==imagesettingsdiv.style.visibility?imagesettingsdiv.style.visibility="hidden":imagesettingsdiv&&imagesettingsdiv.style&&"hidden"==imagesettingsdiv.style.visibility&&(imagesettingsdiv.style.visibility="visible")}():imagesettingsdivvisibility("visible")}}function writeFormdataOfImageToImagesettingsdialogupdate(technicalnumber){let selectedImage=getAllImagedataFromForm(technicalnumber);document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-number").innerHTML=parseInt(selectedImage.technicalnumber)+1;document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-title").value=selectedImage.title;document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-xposition").value=parseInt(selectedImage.xposition);document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-yposition").value=parseInt(selectedImage.yposition);document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-targetwidth").value=parseInt(selectedImage.targetwidth);document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-targetheight").value=parseInt(selectedImage.targetheight);document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-border").value=parseInt(selectedImage.border);document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-borderradius").value=parseInt(selectedImage.borderradius);document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog-url").value=selectedImage.url}function onclickExecute(event){event.target.getAttribute("id").split("button-mform1")[1]||"id-unilabeltype-imageboard-imagesettings-dialog-close"===event.target.getAttribute("id")&&imagesettingsdivvisibility("hidden")}function imagesettingsdivvisibility(visibility){document.getElementById("id-unilabeltype-imageboard-imagesettings-dialog").style.visibility=visibility}async function refreshBackgroundImage(){let previewimage=document.getElementById("id_unilabeltype_imageboard_backgroundimage_fieldset").getElementsByClassName("realpreview"),backgrounddiv=document.getElementById("unilabel-imageboard-background-canvas");if(previewimage.length>0){let backgroundurl=previewimage[0].getAttribute("src").split("?")[0];previewimage[0].getAttribute("src").split("?")[1].includes("&oid=")&&(backgroundurl+="?oid="+previewimage[0].getAttribute("src").split("&oid=")[1]),backgrounddiv.style.background="red",backgrounddiv.style.backgroundSize="cover",backgrounddiv.style.backgroundImage="url('"+backgroundurl+"')";let canvaswidth=document.getElementById("id_unilabeltype_imageboard_canvaswidth").selectedOptions[0].value;backgrounddiv.style.width=canvaswidth+"px";let canvasheight=document.getElementById("id_unilabeltype_imageboard_canvasheight").selectedOptions[0].value;backgrounddiv.style.height=canvasheight+"px",await refreshHelpergrid(canvaswidth,canvasheight,gridcolor,xsteps,ysteps)}else{backgrounddiv.style.background="green",backgrounddiv.style.backgroundImage="url('')";let canvaswidth=document.getElementById("id_unilabeltype_imageboard_canvaswidth").selectedOptions[0].value;backgrounddiv.style.width=canvaswidth+"px";let canvasheight=document.getElementById("id_unilabeltype_imageboard_canvasheight").selectedOptions[0].value;backgrounddiv.style.height=canvasheight+"px",await refreshHelpergrid(canvaswidth,canvasheight,gridcolor,xsteps,ysteps)}_log.default.debug("canvas size changed");const myevent=new CustomEvent("canvaschanged");document.dispatchEvent(myevent)}async function refreshHelpergrid(canvaswidth,canvasheight,gridcolor,xsteps,ysteps){let gridContainer=document.querySelector("#unilabeltype-imageboard-helpergrid-0");if(gridContainer){let gridcontent=await getHelpergrid(canvaswidth,canvasheight,gridcolor,xsteps,ysteps),newGrid=(htmlString=gridcontent.resultHtml,(div=document.createElement("div")).innerHTML=htmlString.trim(),div.firstChild);gridContainer.replaceWith(newGrid),_templates.default.runTemplateJS(gridcontent.resultJs)}else _log.default.debug("No grid found :(");var htmlString,div}async function getHelpergrid(canvaswidth,canvasheight,gridcolor,xsteps,ysteps){let helpergrids=[];for(let y=0;y<canvasheight;y+=ysteps)for(let x=0;x<canvaswidth;x+=xsteps){let helpergrid={};helpergrid.x=x,helpergrid.y=y,x+xsteps>canvaswidth&&(helpergrid.xsteps=x+xsteps-canvaswidth),y+ysteps>canvasheight&&(helpergrid.ysteps=y+ysteps-canvasheight),helpergrids.push(helpergrid)}const context={helpergrids:helpergrids,gridcolor:gridcolor,xsteps:xsteps,ysteps:ysteps,cmid:0,hidden:0};var resultHtml="",resultJs="";return await _templates.default.renderForPromise("unilabeltype_imageboard/imageboard_helpergridpreview",context).then((_ref=>{let{html:html,js:js}=_ref;resultHtml=html,resultJs=js})).catch((()=>{_log.default.debug("Rendering failed")})),{resultHtml:resultHtml,resultJs:resultJs}}async function addImageToDom(number){if(!(number<0))if(document.getElementById("unilabel-imageboard-element-"+number))refreshImage(number);else{let result=await async function(number){if(imageList.includes(number))return{};lastImageNumber=number,imageList.push(lastImageNumber);const context={number:number,displaynumber:parseInt(number)+1,title:"title",src:emptyPictureSrc};let resultHtml,resultJs;return await _templates.default.renderForPromise("unilabeltype_imageboard/previewimage",context).then((_ref2=>{let{html:html,js:js}=_ref2;resultHtml=html,resultJs=js})).catch((()=>{_log.default.debug("Error while rendering from template")})),{resultHtml:resultHtml,resultJs:resultJs}}(number);if(result.resultHtml){document.querySelector("#imageboardcontainer div").insertAdjacentHTML("beforeend",result.resultHtml),_templates.default.runTemplateJS(result.resultJs);let imagefileNode=document.getElementById("fitem_id_unilabeltype_imageboard_image_"+number);if(imagefileNode){require(["core_form/events"],(function(FormEvent){imagefileNode.addEventListener(FormEvent.eventTypes.uploadChanged,(event=>{const filemanager=event.target,interval=setInterval((async()=>{if(!filemanager.classList.contains("fm-updating")&&(clearInterval(interval),filemanager.classList.contains("fm-noitems"))){event.target.getElementsByTagName("img")[0].remove(),function(number){let prevImg=document.querySelector("#unilabel-imageboard-imageid-"+number);prevImg.setAttribute("src",emptyPictureSrc),prevImg.style.background="none",prevImg.style.height="auto",prevImg.style.width="auto",prevImg.style.border="none",prevImg.style.borderRadius=0,_log.default.debug("Image nr "+number+" removed"),document.getElementById("id_unilabeltype_imageboard_targetwidth_"+number).value=0,document.getElementById("id_unilabeltype_imageboard_targetheight_"+number).value=0,document.getElementById("id_unilabeltype_imageboard_border_"+number).value=0,document.getElementById("id_unilabeltype_imageboard_borderradius_"+number).value=0}(number)}}),100)}))})),new MutationObserver((async()=>{await addImageToDom(number),refreshImage(number)})).observe(imagefileNode,{attributes:!0,childList:!0,subtree:!0})}}}}async function refreshImage(number){if(number>=0){let imageid=document.getElementById("unilabel-imageboard-imageid-"+number);if(imageid){let imagedata=getAllImagedataFromForm(number);imageid.src=imagedata.src,""===imagedata.src?imageid.classList.add("hidden"):(imageid.classList.remove("hidden"),imageid.alt=imagedata.alt);const imagediv=document.getElementById("unilabel-imageboard-element-"+number);imagediv.style.left=parseInt(imagedata.xposition)+"px",imagediv.style.top=parseInt(imagedata.yposition)+"px";const idelementtitle=document.getElementById("id_elementtitle-"+number);idelementtitle.classList.remove("unilable-imageboard-titlelineheight-0"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-1"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-2"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-3"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-4"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-5");const dummy="unilable-imageboard-titlelineheight-"+imagedata.titlelineheight;idelementtitle.classList.add(dummy),0!=imagedata.targetwidth?imageid.style.width=imagedata.targetwidth+"px":imageid.style.width="auto",0!=imagedata.targetheight?imageid.style.height=imagedata.targetheight+"px":imageid.style.height="auto",""!=imagedata.title?imageid.title=parseInt(number)+1+": "+imagedata.title:imageid.title=parseInt(number)+1+": ",0!=imagedata.border?(imageid.style.border=imagedata.border+"px solid",imageid.style.borderColor=imagedata.titlebackgroundcolor):imageid.style.border="0",0!=imagedata.borderradius?imageid.style.borderRadius=imagedata.borderradius+"px":imageid.style.borderRadius="0";const elementtitle=document.getElementById("id_elementtitle-"+number);elementtitle.innerHTML=imagedata.title,elementtitle.style.color=imagedata.titlecolor,elementtitle.style.backgroundColor=imagedata.titlebackgroundcolor,elementtitle.style.fontSize=imagedata.fontsize+"px",elementtitle.style.borderRadius=imagedata.borderradius+"px"}}}function getAllImagedataFromForm(technicalnumber){let imageids={title:"id_unilabeltype_imageboard_title_"+technicalnumber,titlecolor:"id_unilabeltype_imageboard_titlecolor_colourpicker",titlebackgroundcolor:"id_unilabeltype_imageboard_titlebackgroundcolor_colourpicker",titlelineheight:"id_unilabeltype_imageboard_titlelineheight",fontsize:"id_unilabeltype_imageboard_fontsize",url:"id_unilabeltype_imageboard_url_"+technicalnumber,alt:"id_unilabeltype_imageboard_alt_"+technicalnumber,xposition:"id_unilabeltype_imageboard_xposition_"+technicalnumber,yposition:"id_unilabeltype_imageboard_yposition_"+technicalnumber,targetwidth:"id_unilabeltype_imageboard_targetwidth_"+technicalnumber,targetheight:"id_unilabeltype_imageboard_targetheight_"+technicalnumber,src:"",border:"id_unilabeltype_imageboard_border_"+technicalnumber,borderradius:"id_unilabeltype_imageboard_borderradius_"+technicalnumber},imagedata={};imagedata.technicalnumber=technicalnumber,imagedata.title=document.getElementById(imageids.title).value,imagedata.titlecolor=document.getElementById(imageids.titlecolor).value,imagedata.titlebackgroundcolor=document.getElementById(imageids.titlebackgroundcolor).value,imagedata.titlelineheight=document.getElementById(imageids.titlelineheight).value,imagedata.fontsize=document.getElementById(imageids.fontsize).value,imagedata.url=document.getElementById(imageids.url).value,imagedata.alt=document.getElementById(imageids.alt).value,imagedata.xposition=document.getElementById(imageids.xposition).value,imagedata.yposition=document.getElementById(imageids.yposition).value,imagedata.targetwidth=document.getElementById(imageids.targetwidth).value,imagedata.targetheight=document.getElementById(imageids.targetheight).value;const imagetag=document.getElementById("id_unilabeltype_imageboard_image_"+technicalnumber+"_fieldset").getElementsByTagName("img");let src=emptyPictureSrc;return imagetag.length&&0!=imagetag.length&&(src=imagetag[0].src,src=src.split("?")[0]),imagedata.src=src,imagedata.border=document.getElementById(imageids.border).value,imagedata.borderradius=document.getElementById(imageids.borderradius).value,imagedata}(await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["unilabeltype_imageboard/imageboarddraganddrop"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("unilabeltype_imageboard/imageboarddraganddrop")):Promise.resolve(_systemImportTransformerGlobalIdentifier["unilabeltype_imageboard/imageboarddraganddrop"]))).init()}}));

//# sourceMappingURL=imageboardpreviewrenderer.min.js.map