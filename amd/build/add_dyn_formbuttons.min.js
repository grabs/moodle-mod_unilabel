define("mod_unilabel/add_dyn_formbuttons",["exports","mod_unilabel/contentloader","core/templates","core/notification","core/log"],(function(_exports,_contentloader,_templates,_notification,_log){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_contentloader=_interopRequireDefault(_contentloader),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log);var _systemImportTransformerGlobalIdentifier="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:{};function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}let _formid,_type,_elements;const registerActionButtons=(headerelement,useVisibility,index)=>{const context={type:_type,repeatindex:index,repeatnr:index+1};return _templates.default.renderForPromise("mod_unilabel/element_action_buttons",context).then((_ref=>{let{html:html,js:js}=_ref;headerelement.querySelector("div.d-flex").insertAdjacentHTML("beforeend",html),useVisibility&&initVisibleButton(headerelement,index),_templates.default.runTemplateJS(js)})).catch((error=>_notification.default.exception(error)))},initVisibleButton=(headerelement,index)=>{headerelement.classList.add("has-visibility");var visibleElement=document.getElementsByName("unilabeltype_"+_type+"_visible["+index+"]")[0];if(visibleElement){var visibleButton=headerelement.querySelector("a.visible-button i");visibleButton&&setVisibilityStyle(visibleButton,"1"==visibleElement.value)}},setVisibilityStyle=(visibleButton,enabled)=>{enabled?(visibleButton.classList.remove("fa-eye-slash"),visibleButton.classList.add("fa-eye"),visibleButton.closest("fieldset").classList.remove("visible-off")):(visibleButton.classList.remove("fa-eye"),visibleButton.classList.add("fa-eye-slash"),visibleButton.closest("fieldset").classList.add("visible-off"))};_exports.init=async(type,formid,contextid,prefix,elements,useDragdrop,useVisibility)=>{(await("function"==typeof _systemImportTransformerGlobalIdentifier.define&&_systemImportTransformerGlobalIdentifier.define.amd?new Promise((function(resolve,reject){_systemImportTransformerGlobalIdentifier.require(["mod_unilabel/dragdrop"],resolve,reject)})):"undefined"!=typeof module&&module.exports&&"undefined"!=typeof require||"undefined"!=typeof module&&module.component&&_systemImportTransformerGlobalIdentifier.require&&"component"===_systemImportTransformerGlobalIdentifier.require.loader?Promise.resolve(require("mod_unilabel/dragdrop")):Promise.resolve(_systemImportTransformerGlobalIdentifier["mod_unilabel/dragdrop"]))).init(type,formid,useDragdrop),_type=type,_formid=formid,_elements=elements;var thisform=document.querySelector("#"+formid);thisform.addEventListener("click",(e=>{var index;"shoulddelete"==e.target.dataset.action&&e.preventDefault(),"deleteelement"==e.target.dataset.action&&(index=e.target.dataset.id,_log.default.debug("Deleting element: "+index),(index=>{var headerelement=document.querySelector("#id_singleelementheader_"+index);headerelement&&headerelement.remove();var thisform=document.querySelector("#"+_formid),myparent=document.querySelector("#id_unilabelcontenthdr");if(myparent){var newelement;_elements.forEach((element=>{let name="unilabeltype_"+_type+"_"+element+"["+index+"]";_log.default.debug("Set dummy element "+name),(newelement=document.createElement("input")).type="hidden",newelement.name=name,newelement.value="",myparent.insertAdjacentElement("afterbegin",newelement)}));const myevent=new CustomEvent("itemremoved",{detail:index});thisform.dispatchEvent(myevent)}})(index)),"setvisible"==e.target.dataset.action&&(e.preventDefault(),(index=>{_log.default.debug("Set element visible/visible-off: "+index);var visibleElement=document.getElementsByName("unilabeltype_"+_type+"_visible["+index+"]")[0];if(visibleElement){visibleElement.value="1"==visibleElement.value?"0":"1";var visibleButton=document.querySelector("#id_singleelementheader_"+index+" a.visible-button i");visibleButton&&setVisibilityStyle(visibleButton,"1"==visibleElement.value)}})(index=e.target.dataset.id),_log.default.debug("GRABS:"),_log.default.debug(e),e.target.closest("form").dataset.formDirty=!0)}));for(var headerelements=document.querySelectorAll('fieldset[id^="id_singleelementheader"]'),i=0;i<headerelements.length;i++){var headerelement=headerelements[i];_log.default.debug("looking for: "+headerelement.id),registerActionButtons(headerelement,useVisibility,i)}var button=document.querySelector("#button-"+formid);if(button){var repeatbutton=document.querySelector("#fitem_id_"+prefix+"add_more_elements_btn");repeatbutton&&repeatbutton.remove(),button.addEventListener("click",(e=>{var contentcontainerselector="#addcontent-"+formid,repeatindex=parseInt(e.target.form.multiple_chosen_elements_count.value),serviceparams={contextid:contextid,formid:formid,repeatindex:repeatindex};_log.default.debug(serviceparams),e.target.form.multiple_chosen_elements_count.value=repeatindex+1,e.target.form.dataset.formDirty=!0,new _contentloader.default(contentcontainerselector,"get_edit_element",serviceparams,contextid).loadContent("beforebegin").then((()=>{if(useVisibility){var headerelement=document.querySelector("#id_singleelementheader_"+repeatindex);initVisibleButton(headerelement,repeatindex)}const myevent=new CustomEvent("itemadded",{detail:repeatindex});return thisform.dispatchEvent(myevent),!0})).catch((error=>_notification.default.exception(error)))}))}}}));

//# sourceMappingURL=add_dyn_formbuttons.min.js.map